{% extends "base_tools.html" %}

{% block title %}PID Tuning | Nexus{% endblock %}

{% block head_extra %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
    .parameter-input { margin-bottom: 15px; }
    .results-section { margin-top: 30px; }
    .metric-card { margin: 10px 0; }
    .chart-container { height: 400px; margin: 20px 0; }
    .advanced-params { display: none; }
    .toggle-btn { cursor: pointer; color: #2196F3; }
</style>
{% endblock %}

{% block content %}

{% if error %}
<div class="w3-panel w3-red w3-round-large w3-margin-top">
    <h3>Error</h3>
    <p>{{ error }}</p>
</div>
{% endif %}

<div class="w3-container w3-card w3-white w3-round-large w3-margin-top">
    <h3>Manual PID Tuning</h3>
    <p>Enter PID parameters to simulate controller performance:</p>

    <form action="/pid" method="post" class="w3-container">

        <div class="w3-row-padding">
            <div class="w3-col l4 m6 s12 parameter-input">
                <label for="kp" class="w3-text-dark-grey"><b>Proportional Gain (Kp):</b></label>
                <input class="w3-input w3-border w3-round" type="number" step="0.01" id="kp" name="kp"
                       value="{{ request.form.kp if request.form.kp else '1.0' }}"
                       min="0.01" max="100" required>
                <small class="w3-text-grey">Range: 0.01 to 100</small>
            </div>

            <div class="w3-col l4 m6 s12 parameter-input">
                <label for="ki" class="w3-text-dark-grey"><b>Integral Gain (Ki):</b></label>
                <input class="w3-input w3-border w3-round" type="number" step="0.001" id="ki" name="ki"
                       value="{{ request.form.ki if request.form.ki else '0.1' }}"
                       min="0.001" max="10" required>
                <small class="w3-text-grey">Range: 0.001 to 10</small>
            </div>

            <div class="w3-col l4 m6 s12 parameter-input">
                <label for="kd" class="w3-text-dark-grey"><b>Derivative Gain (Kd):</b></label>
                <input class="w3-input w3-border w3-round" type="number" step="0.001" id="kd" name="kd"
                       value="{{ request.form.kd if request.form.kd else '0.05' }}"
                       min="0.0" max="5" required>
                <small class="w3-text-grey">Range: 0.0 to 5</small>
            </div>
        </div>

        <p class="toggle-btn" onclick="toggleAdvanced()">
            <span id="toggle-text">▶ Show Advanced System Parameters</span>
        </p>

        <div id="advanced-params" class="advanced-params w3-row-padding">
            <div class="w3-col l3 m6 s12 parameter-input">
                <label for="process_gain" class="w3-text-dark-grey"><b>Process Gain:</b></label>
                <input class="w3-input w3-border w3-round" type="number" step="0.1" id="process_gain" name="process_gain"
                       value="{{ request.form.process_gain if request.form.process_gain else '1.0' }}">
            </div>

            <div class="w3-col l3 m6 s12 parameter-input">
                <label for="dead_time" class="w3-text-dark-grey"><b>Dead Time (s):</b></label>
                <input class="w3-input w3-border w3-round" type="number" step="0.1" id="dead_time" name="dead_time"
                       value="{{ request.form.dead_time if request.form.dead_time else '2.0' }}">
            </div>

            <div class="w3-col l3 m6 s12 parameter-input">
                <label for="time_constant" class="w3-text-dark-grey"><b>Time Constant (s):</b></label>
                <input class="w3-input w3-border w3-round" type="number" step="0.1" id="time_constant" name="time_constant"
                       value="{{ request.form.time_constant if request.form.time_constant else '5.0' }}">
            </div>

            <div class="w3-col l3 m6 s12 parameter-input">
                <label for="setpoint" class="w3-text-dark-grey"><b>Setpoint:</b></label>
                <input class="w3-input w3-border w3-round" type="number" step="0.1" id="setpoint" name="setpoint"
                       value="{{ request.form.setpoint if request.form.setpoint else '50.0' }}">
            </div>
        </div>

        <button class="w3-button w3-blue w3-round-large w3-margin-top" type="submit">
            Simulate PID Response
        </button>
    </form>
</div>

{% if results and success %}
<div class="results-section">

    <div class="w3-container w3-card w3-white w3-round-large w3-margin-top">
        <h3>Performance Metrics</h3>
        <div class="w3-row-padding">
            <div class="w3-col l3 m6 s12">
                <div class="w3-panel w3-blue w3-round metric-card">
                    <h4>Settling Time</h4>
                    <p class="w3-xlarge">{{ results.performance_metrics.settling_time }}s</p>
                </div>
            </div>
            <div class="w3-col l3 m6 s12">
                <div class="w3-panel w3-green w3-round metric-card">
                    <h4>Overshoot</h4>
                    <p class="w3-xlarge">{{ results.performance_metrics.overshoot }}%</p>
                </div>
            </div>
            <div class="w3-col l3 m6 s12">
                <div class="w3-panel w3-orange w3-round metric-card">
                    <h4>Steady State Error</h4>
                    <p class="w3-xlarge">{{ results.performance_metrics.steady_state_error }}</p>
                </div>
            </div>
            <div class="w3-col l3 m6 s12">
                <div class="w3-panel w3-purple w3-round metric-card">
                    <h4>Final PV</h4>
                    <p class="w3-xlarge">{{ results.performance_metrics.final_pv }}</p>
                </div>
            </div>
        </div>
    </div>

    <div class="w3-container w3-card w3-white w3-round-large w3-margin-top">
        <h3>Simulation Results</h3>
        <div class="chart-container">
            <canvas id="pidChart"></canvas>
        </div>
    </div>

    <div class="w3-container w3-card w3-white w3-round-large w3-margin-top">
        <h3>System Configuration</h3>
        <div class="w3-row-padding">
            <div class="w3-col l4 m6 s12">
                <p><b>Process Gain:</b> {{ results.system_params.process_gain }}</p>
            </div>
            <div class="w3-col l4 m6 s12">
                <p><b>Dead Time:</b> {{ results.system_params.dead_time }}s</p>
            </div>
            <div class="w3-col l4 m6 s12">
                <p><b>Time Constant:</b> {{ results.system_params.time_constant }}s</p>
            </div>
        </div>
    </div>

</div>
{% endif %}

{% endblock %}

{% block scripts %}
{% if results %}
<script>
const ctx = document.getElementById('pidChart').getContext('2d');
const chart = new Chart(ctx, {
    type: 'line',
    data: {
        labels: {{ results.simulation_data.time | safe }},
        datasets: [{
            label: 'Process Variable (PV)',
            data: {{ results.simulation_data.pv | safe }},
            tension: 0.1
        }, {
            label: 'Setpoint (SP)',
            data: {{ results.simulation_data.setpoint | safe }},
            borderDash: [5, 5],
            tension: 0.1
        }, {
            label: 'Control Variable (CV)',
            data: {{ results.simulation_data.cv | safe }},
            tension: 0.1,
            yAxisID: 'y1'
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
            x: { title: { display: true, text: 'Time (seconds)' } },
            y: { position: 'left', title: { display: true, text: 'Process Variable / Setpoint' } },
            y1: { position: 'right', grid: { drawOnChartArea: false }, title: { display: true, text: 'Control Variable' } }
        },
        plugins: {
            title: { display: true, text: 'PID Controller Response' },
            legend: { display: true }
        }
    }
});

function toggleAdvanced() {
    const params = document.getElementById('advanced-params');
    const toggleText = document.getElementById('toggle-text');

    if (params.style.display === 'none' || params.style.display === '') {
        params.style.display = 'block';
        toggleText.innerHTML = '▼ Hide Advanced System Parameters';
    } else {
        params.style.display = 'none';
        toggleText.innerHTML = '▶ Show Advanced System Parameters';
    }
}
</script>
{% endif %}
{% endblock %}