{% extends "base_tools.html" %}

{% block title %}PID Auto Tune | Nexus{% endblock %}

{% block content %}

{% if error %}
<div class="w3-panel w3-red w3-round-large w3-margin-top">
    <h3>Error</h3>
    <p>{{ error }}</p>
</div>
{% endif %}

<div class="w3-container w3-card w3-white w3-round-large w3-margin-top">
    <h3>Automatic PID Parameter Optimization</h3>
    <p>Set your performance targets and parameter bounds. The optimizer will find the best PID values.</p>

    <form action="/pid/optimize" method="post" class="w3-container">

        <h4 class="w3-text-blue">Performance Targets</h4>
        <div class="w3-row-padding">
            <div class="w3-col l4 m6 s12 parameter-input">
                <label for="max_settling_time" class="w3-text-dark-grey"><b>Max Settling Time (s):</b></label>
                <input class="w3-input w3-border w3-round" type="number" step="0.1" id="max_settling_time" name="max_settling_time"
                       value="{{ request.form.max_settling_time if request.form.max_settling_time else '10.0' }}" required>
            </div>

            <div class="w3-col l4 m6 s12 parameter-input">
                <label for="max_overshoot" class="w3-text-dark-grey"><b>Max Overshoot (%):</b></label>
                <input class="w3-input w3-border w3-round" type="number" step="0.1" id="max_overshoot" name="max_overshoot"
                       value="{{ request.form.max_overshoot if request.form.max_overshoot else '5.0' }}" required>
            </div>

            <div class="w3-col l4 m6 s12 parameter-input">
                <label for="max_steady_error" class="w3-text-dark-grey"><b>Max Steady State Error:</b></label>
                <input class="w3-input w3-border w3-round" type="number" step="0.01" id="max_steady_error" name="max_steady_error"
                       value="{{ request.form.max_steady_error if request.form.max_steady_error else '1.0' }}" required>
            </div>
        </div>

        <h4 class="w3-text-green">Parameter Search Bounds</h4>

        <div class="w3-row-padding">
            <div class="w3-col l6 m12 s12">
                <h5>Proportional Gain (Kp)</h5>
                <div class="w3-row-padding">
                    <div class="w3-col s6 parameter-input">
                        <label for="kp_min" class="w3-text-dark-grey">Min:</label>
                        <input class="w3-input w3-border w3-round" type="number" step="0.01" id="kp_min" name="kp_min"
                               value="{{ request.form.kp_min if request.form.kp_min else '0.1' }}">
                    </div>
                    <div class="w3-col s6 parameter-input">
                        <label for="kp_max" class="w3-text-dark-grey">Max:</label>
                        <input class="w3-input w3-border w3-round" type="number" step="0.01" id="kp_max" name="kp_max"
                               value="{{ request.form.kp_max if request.form.kp_max else '10.0' }}">
                    </div>
                </div>
            </div>

            <div class="w3-col l6 m12 s12">
                <h5>Integral Gain (Ki)</h5>
                <div class="w3-row-padding">
                    <div class="w3-col s6 parameter-input">
                        <label for="ki_min" class="w3-text-dark-grey">Min:</label>
                        <input class="w3-input w3-border w3-round" type="number" step="0.001" id="ki_min" name="ki_min"
                               value="{{ request.form.ki_min if request.form.ki_min else '0.01' }}">
                    </div>
                    <div class="w3-col s6 parameter-input">
                        <label for="ki_max" class="w3-text-dark-grey">Max:</label>
                        <input class="w3-input w3-border w3-round" type="number" step="0.001" id="ki_max" name="ki_max"
                               value="{{ request.form.ki_max if request.form.ki_max else '2.0' }}">
                    </div>
                </div>
            </div>
        </div>

        <div class="w3-row-padding">
            <div class="w3-col l6 m12 s12">
                <h5>Derivative Gain (Kd)</h5>
                <div class="w3-row-padding">
                    <div class="w3-col s6 parameter-input">
                        <label for="kd_min" class="w3-text-dark-grey">Min:</label>
                        <input class="w3-input w3-border w3-round" type="number" step="0.001" id="kd_min" name="kd_min"
                               value="{{ request.form.kd_min if request.form.kd_min else '0.001' }}">
                    </div>
                    <div class="w3-col s6 parameter-input">
                        <label for="kd_max" class="w3-text-dark-grey">Max:</label>
                        <input class="w3-input w3-border w3-round" type="number" step="0.001" id="kd_max" name="kd_max"
                               value="{{ request.form.kd_max if request.form.kd_max else '1.0' }}">
                    </div>
                </div>
            </div>
        </div>

        <button class="w3-button w3-orange w3-round-large w3-margin-top w3-large" type="submit">
            Start Auto Tuning
        </button>
    </form>
</div>

{% if optimization_results and success %}
<div class="w3-container w3-card w3-white w3-round-large w3-margin-top">

    {% if optimization_results.success %}
    <h3 class="w3-text-green">Optimization Successful</h3>

    <div class="w3-row-padding w3-margin-top">
        <div class="w3-col l4 m6 s12">
            <div class="w3-panel w3-blue w3-round metric-card">
                <h4>Optimized Kp</h4>
                <p class="w3-xlarge">{{ optimization_results.optimized_params.kp }}</p>
            </div>
        </div>
        <div class="w3-col l4 m6 s12">
            <div class="w3-panel w3-green w3-round metric-card">
                <h4>Optimized Ki</h4>
                <p class="w3-xlarge">{{ optimization_results.optimized_params.ki }}</p>
            </div>
        </div>
        <div class="w3-col l4 m6 s12">
            <div class="w3-panel w3-orange w3-round metric-card">
                <h4>Optimized Kd</h4>
                <p class="w3-xlarge">{{ optimization_results.optimized_params.kd }}</p>
            </div>
        </div>
    </div>

    <h4>Achieved Performance</h4>
    <div class="w3-row-padding">
        <div class="w3-col l3 m6 s12">
            <div class="w3-panel w3-light-blue w3-round">
                <p><b>Settling Time:</b> {{ optimization_results.performance.settling_time }}s</p>
            </div>
        </div>
        <div class="w3-col l3 m6 s12">
            <div class="w3-panel w3-light-green w3-round">
                <p><b>Overshoot:</b> {{ optimization_results.performance.overshoot }}%</p>
            </div>
        </div>
        <div class="w3-col l3 m6 s12">
            <div class="w3-panel w3-light-orange w3-round">
                <p><b>Steady State Error:</b> {{ optimization_results.performance.steady_state_error }}</p>
            </div>
        </div>
        <div class="w3-col l3 m6 s12">
            <div class="w3-panel w3-light-grey w3-round">
                <p><b>Iterations:</b> {{ optimization_results.iterations }}</p>
            </div>
        </div>
    </div>

    <div class="w3-margin-top">
        <a href="/pid?kp={{ optimization_results.optimized_params.kp }}&ki={{ optimization_results.optimized_params.ki }}&kd={{ optimization_results.optimized_params.kd }}"
           class="w3-button w3-purple w3-round-large">
            Test These Parameters
        </a>
    </div>

    {% else %}
    <h3 class="w3-text-red">Optimization Failed</h3>
    <p>{{ optimization_results.error }}</p>
    {% endif %}
</div>
{% endif %}

{% endblock %}